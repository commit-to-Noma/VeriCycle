<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collector Dashboard - VeriCycle</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
</head>
<body class="dark-theme">
    {% include '_navbar.html' %}

    <main class="container app-dashboard" style="overflow:visible;">
        <div class="dashboard-header">
            <h2>Welcome back, {{ current_user.email.split('@')[0] }}!</h2>
            <p>Here is your recycling progress.</p>
        </div>

        <div class="dashboard-grid">
            
            <div class="kpi-card">
                <h3>
                    Current EcoCoin Balance
                    <span class="tooltip" data-tooltip="This shows your current account balance available to spend or withdraw.">â“˜</span>
                </h3>
                <p class="kpi-value" id="kpi-ecocoin">--</p>
                
                <a href="{{ url_for('swap') }}" class="btn-primary" style="width: 100%; box-sizing: border-box; margin-top: 1.5rem; text-align: center;">
                    Wallet & Exchange
                </a>
            </div>
            
            <div class="kpi-card">
                <h3>Total Kilograms Recycled</h3>
                <p class="kpi-value" id="kpi-kg">--</p>
            </div>

            <div class="chart-card">
                <h3>Personal Goal</h3>
                <p class="chart-label" id="personal-goal-label">-- / -- kg</p>
                
                <div class="chart-canvas-container">
                    <span class="chart-percentage" id="personal-percent">--%</span>
                    <canvas id="personalGoalChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3>
                    Neighborhood Goal
                    <span class="tooltip" data-tooltip="Your neighborhood (Sandton) is a high-activity area, so you earn a +2.5% bonus on all EcoCoin payouts!">â“˜</span>
                </h3>
                <p class="chart-label" id="neighborhood-goal-label">-- / -- kg</p>
                
                <div class="chart-canvas-container">
                    <span class="chart-percentage" id="neighborhood-percent">--%</span>
                    <canvas id="neighborhoodGoalChart"></canvas>
                </div>
                </div>

            <div class="card proof-income" style="grid-column: 1 / -1; display: flex; align-items: center; justify-content: space-between; padding: 1.5rem; min-height: 0; height: auto;">
                <div>
                    <h3 style="margin-bottom: 0.25rem;">Proof of Income Report</h3>
                    <p style="color: #aaa; margin: 0; font-size: 0.9rem;">Download your official verified transaction history.</p>
                </div>
                <a href="{{ url_for('static', filename='sample_report.pdf') }}" target="_blank" class="btn-secondary" style="margin-top: 0;">
                    Download PDF ðŸ“„
                </a>
            </div>

            <div class="card" id="activity-section" style="grid-column: 1 / -1; margin-top: 0;">
                <h3>Recent Activity</h3>
                <p class="mockup-subtitle">Your HCS-verified transaction log.</p>
                
                <ul class="activity-list">
                </ul>
            </div>

        </div>

    <!-- This is the new 2-column QR card -->
    <div class="card">
        <div class="qr-grid">

            <div class="instructions">
                <h3>How to Drop Off:</h3>
                <ol>
                    <li>Press the "Generate" button below.</li>
                    <li>Show your unique QR code to the recycling center.</li>
                    <li>The center will scan your code and weigh your materials.</li>
                    <li>Your EcoCoin reward will be deposited instantly!</li>
                </ol>
                <button class="btn-primary" id="generate-btn">Generate Drop-off QR Code</button>
            </div>
            
            <div class="qr-code-container" id="qr-code-container">
                <div class="qr-placeholder">
                    Click "Generate" to create your code
                </div>
            </div>

        </div> </div>

    

    <a href="{{ url_for('request_pickup') }}" class="pickup-card-link">
        <div class="card pickup-card">
            <div class="pickup-icon">ðŸšš</div>
            <div class="pickup-text">
                <h3>Request a Pickup</h3>
                <p>Have too much to drop off? Schedule a pickup from your location.</p>
            </div>
            <div class="pickup-arrow">â€º</div>
        </div>
    </a>

    <div class="card" id="faq-section">
        <h3>Need Help?</h3>
        <p class="mockup-subtitle">Find answers to common questions about your dashboard.</p>
        
        <div class="faq-grid">
            <ul class="faq-list">
                <li><a href="#">How is my "Total EcoCoin" calculated?</a></li>
                <li><a href="#">What is a "Personal Goal"?</a></li>
                <li><a href="#">Why hasn't my drop-off appeared yet?</a></li>
                <li><a href="#">How do I find my Hedera wallet keys?</a></li>
            </ul>
            <ul class="faq-list">
                <li><a href="#">What is the "Neighborhood Goal"?</a></li>
                <li><a href="#">How do I redeem my EcoCoin for ZAR?</a></li>
                <li><a href="#">Can I change my weekly goal?</a></li>
                <li><a href="#">How do I update my profile information?</a></li>
            </ul>
        </div>
    </div>

    

    <div class="card" style="background-color: #333; border: 1px solid #E57373;">
         <button class="btn-primary" id="simulate-deposit-btn" style="background-color: #0D47A1; width: 100%; box-sizing: border-box;">
            Refresh Balance (Simulate Scan)
        </button>
        {% if current_user.email.lower() == 'demo@vericycle.com' %}
        <button class="btn-secondary" id="reset-demo-btn" style="width: 100%; box-sizing: border-box; margin-top: 1rem; border-color: #E57373; color: #E57373;">
            Reset Demo
        </button>
        {% endif %}
    </div>

    </main>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- 1. GLOBAL VARIABLES ---
        const generateButton = document.getElementById('generate-btn');
        const qrContainer = document.getElementById('qr-code-container');
        let personalChart = null;
        let neighborhoodChart = null;
        let currentData = {}; 
        let pendingAnim = null; // holds pending animation values until modal is closed

        // --- BROADCAST LISTENER (Auto-update) ---
        const channel = new BroadcastChannel('vericycle_demo');
        channel.onmessage = (event) => {
            if (event.data.type === 'DEPOSIT') {
                handleDeposit();
            }
        };

        // --- 2. ANIMATION FUNCTION ---
        function animateValue(element, start, end, duration, suffix = '', decimals = 0) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                let currentValue = progress * (end - start) + start;
                element.textContent = currentValue.toFixed(decimals) + suffix;
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        // Smooth-scroll helper (animates scroll to top over `duration` ms)
        function smoothScrollToTop(duration = 350) {
            const start = document.documentElement.scrollTop || document.body.scrollTop || 0;
            if (start === 0) return;
            const startTime = performance.now();
            const step = (now) => {
                const elapsed = now - startTime;
                const t = Math.min(1, elapsed / duration);
                // easeOutCubic
                const eased = 1 - Math.pow(1 - t, 3);
                const current = Math.round(start * (1 - eased));
                window.scrollTo(0, current);
                if (t < 1) requestAnimationFrame(step);
                else {
                    window.scrollTo(0, 0);
                }
            };
            requestAnimationFrame(step);
        }

        // Animate scrollTop for any element (works for documentElement/body as well)
        function smoothScrollElementToTop(el, duration = 350) {
            if (!el) return Promise.resolve();
            return new Promise((resolve) => {
                const initial = el.scrollTop || 0;
                if (initial === 0) { resolve(); return; }
                const startTime = performance.now();
                const tick = (now) => {
                    const elapsed = now - startTime;
                    const t = Math.min(1, elapsed / duration);
                    const eased = 1 - Math.pow(1 - t, 3);
                    const value = Math.round(initial * (1 - eased));
                    try { el.scrollTop = value; } catch (e) {}
                    // For document, sync both
                    if (el === document.documentElement || el === document.body) {
                        try { document.documentElement.scrollTop = value; } catch (e) {}
                        try { document.body.scrollTop = value; } catch (e) {}
                        try { window.scrollTo(0, value); } catch (e) {}
                    }
                    if (t < 1) requestAnimationFrame(tick);
                    else { try { el.scrollTop = 0; } catch(e){}; resolve(); }
                };
                requestAnimationFrame(tick);
            });
        }

        // animateValue that returns a Promise resolved after duration
        function animateValuePromise(element, start, end, duration, suffix = '', decimals = 0) {
            return new Promise((resolve) => {
                animateValue(element, start, end, duration, suffix, decimals);
                setTimeout(() => resolve(), duration + 20);
            });
        }

        // --- 3. QR CODE LOGIC ---
        generateButton.addEventListener('click', function() {
            if (!currentData.profile_complete) {
                alert("Please complete your profile before generating a QR code.");
                window.location.href = "/profile";
                return;
            }
            qrContainer.innerHTML = ''; 
            const qrImage = document.createElement('img');
            qrImage.src = '/generate-qr?' + new Date().getTime();
            qrContainer.appendChild(qrImage);
        });

        // --- 4. MAIN DATA LOADER ---
        async function initializeDashboard() {
            try {
                // A. Get Base Server Data (1175 ECO)
                const response = await fetch('/api/my-dashboard-data');
                const serverData = await response.json();
                
                // B. Check LocalStorage (User Progress)
                let storedData = localStorage.getItem('userBalance');
                
                if (storedData) {
                    // If we have saved progress, USE IT.
                    currentData = JSON.parse(storedData);
                    
                    // Merge activities carefully to avoid losing server history
                    if (!currentData.activities || currentData.activities.length === 0) {
                        currentData.activities = serverData.activities;
                    }
                } else {
                    // First time load: Use Server Data
                    currentData = serverData;
                    localStorage.setItem('userBalance', JSON.stringify(currentData));
                }

                // C. Handle Withdrawal Return (The "Flag")
                const withdrawalFlag = sessionStorage.getItem('demo_just_withdrew');
                if (withdrawalFlag) {
                    const withdrawalData = JSON.parse(withdrawalFlag);

                    // Capture old values for animation
                    const oldEco = Number(currentData.total_eco) || 0;
                    const oldKg = Number(currentData.total_kg) || 0;
                    const oldPersonal = Number(currentData.current_kg) || 0;
                    const oldNeighborhood = Number(currentData.neighborhood_current_kg) || 0;

                    // Compute new values (swap deducts ECO only in demo)
                    const newEco = oldEco - (Number(withdrawalData.swapAmount) || 0);
                    const newKg = oldKg;
                    const newPersonal = oldPersonal;
                    const newNeighborhood = oldNeighborhood;

                    // Apply changes to currentData
                    currentData.total_eco = newEco;

                    // Add Swap Transaction
                    currentData.activities.unshift({
                        timestamp: new Date().toISOString(),
                        desc: withdrawalData.swapDesc,
                        amount: -withdrawalData.swapAmount
                    });

                    // Add Withdrawal Transaction
                    currentData.activities.unshift({
                        timestamp: new Date().toISOString(),
                        desc: withdrawalData.withdrawDesc,
                        amount: 0
                    });

                    // Record pending animation so numbers animate when the dashboard loads
                    pendingAnim = {
                        type: 'withdraw',
                        oldEco, newEco,
                        oldKg, newKg,
                        oldPersonal, newPersonal,
                        oldNeighborhood, newNeighborhood,
                        swapAmount: Number(withdrawalData.swapAmount) || 0
                    };

                    sessionStorage.removeItem('demo_just_withdrew');
                    localStorage.setItem('userBalance', JSON.stringify(currentData));
                }

                // D. Draw Dashboard
                drawDashboard(currentData);
                renderActivityList();

                // If a pending animation was recorded (e.g. from a withdraw flag),
                // run it immediately so the user sees the animated update on load.
                if (pendingAnim) {
                    // Ensure viewport is at top before running animations
                    const docEl = document.documentElement;
                    const bodyEl = document.body;
                    const mainDashboard = document.querySelector('.app-dashboard') || document.querySelector('main') || null;
                    Promise.all([
                        smoothScrollElementToTop(docEl, 200),
                        smoothScrollElementToTop(bodyEl, 200)
                    ]).then(() => {
                        if (mainDashboard) return smoothScrollElementToTop(mainDashboard, 180);
                    }).then(() => runPendingAnimations()).catch(() => runPendingAnimations());
                }

            } catch (e) {
                console.error("Error initializing dashboard:", e);
            }
        }

        // --- 5. HANDLE DEPOSIT (Simulation Logic) ---
        function handleDeposit() {
            // Prepare values
            const bonusAmount = 518.00;
            const weightAmount = 10.0;

            // Ensure numeric coercion (defend against strings in localStorage)
            let oldEco = Number(currentData.total_eco) || 0;
            let oldKg = Number(currentData.total_kg) || 0;
            let oldPersonal = Number(currentData.current_kg) || 0;
            let oldNeighborhood = Number(currentData.neighborhood_current_kg) || 0;

            const newEco = oldEco + bonusAmount;
            const newKg = oldKg + weightAmount;
            const newPersonal = oldPersonal + weightAmount;
            const newNeighborhood = oldNeighborhood + weightAmount;
            // Update data model now (store new values immediately)
            currentData.total_eco = newEco;
            currentData.total_kg = newKg;
            currentData.current_kg = newPersonal;
            currentData.neighborhood_current_kg = newNeighborhood;

            // Add activity
            const now = new Date();
            currentData.activities = currentData.activities || [];
            currentData.activities.unshift({
                timestamp: now.toISOString(),
                desc: `Verified Drop-off (10.0kg of Cans)`,
                amount: bonusAmount
            });

            // Persist state
            localStorage.setItem('userBalance', JSON.stringify(currentData));

            // Re-render the activity list so the new item appears
            renderActivityList();

            // Save pending animation payload so the numbers animate after the user presses 'Awesome!'
            pendingAnim = {
                type: 'deposit',
                oldEco, newEco,
                oldKg, newKg,
                oldPersonal, newPersonal,
                oldNeighborhood, newNeighborhood,
                bonusAmount, weightAmount
            };

            // Show the modal immediately; actual scroll + animations run when user clicks "Awesome!"
            document.querySelector('#success-modal .success-subtitle').textContent = `A new drop-off of ${weightAmount.toFixed(1)}kg has been verified.`;
            const confettiCanvas = document.getElementById('confetti-canvas');
            const modalConfetti = confetti.create(confettiCanvas, { resize: true, useWorker: true });
            document.getElementById('success-modal').style.display = 'flex';
            modalConfetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }

        // --- 6. DRAW DASHBOARD (Static Render) ---
        function drawDashboard(data) {
             // Safety fallback for zeroes
             const eco = data.total_eco || 0;
             const kg = data.total_kg || 0;
             const curKg = data.current_kg || 0;
             const goalKg = data.weekly_goal || 30;
             const hoodCur = data.neighborhood_current_kg || 0;
             const hoodGoal = data.neighborhood_goal_kg || 1000;

             document.getElementById('kpi-ecocoin').textContent = eco.toFixed(0);
             document.getElementById('kpi-kg').textContent = `${kg.toFixed(1)} kg`;
             
             document.getElementById('personal-goal-label').textContent = `${curKg.toFixed(1)} / ${goalKg.toFixed(1)} kg`;
             document.getElementById('neighborhood-goal-label').textContent = `${hoodCur.toFixed(1)} / ${hoodGoal.toFixed(1)} kg`;

             // Update Charts (Static)
             // ... (Keep your existing Chart.js code here) ...
             // Use the code from previous steps for Chart creation
             updateCharts(curKg, goalKg, hoodCur, hoodGoal);
        }

        // Run any pending animations that were recorded (deposit or withdrawal)
        function runPendingAnimations() {
            if (!pendingAnim) return Promise.resolve();
            const anim = pendingAnim;
            pendingAnim = null; // clear immediately to avoid double-run

            const ecEl = document.getElementById('kpi-ecocoin');
            const kgEl = document.getElementById('kpi-kg');
            const pPctEl = document.getElementById('personal-percent');
            const nPctEl = document.getElementById('neighborhood-percent');

            // compute percentages safely
            const oldPersonalPct = (anim.oldPersonal / (currentData.weekly_goal || 30)) * 100;
            const newPersonalPct = (anim.newPersonal / (currentData.weekly_goal || 30)) * 100;
            const oldNeighborhoodPct = (anim.oldNeighborhood / (currentData.neighborhood_goal_kg || 1000)) * 100;
            const newNeighborhoodPct = (anim.newNeighborhood / (currentData.neighborhood_goal_kg || 1000)) * 100;

            const promises = [
                animateValuePromise(ecEl, anim.oldEco, anim.newEco, 900, '', 0),
                animateValuePromise(kgEl, anim.oldKg, anim.newKg, 900, ' kg', 1),
                animateValuePromise(pPctEl, oldPersonalPct, newPersonalPct, 900, '%', 0),
                animateValuePromise(nPctEl, oldNeighborhoodPct, newNeighborhoodPct, 900, '%', 1)
            ];

            return Promise.all(promises).then(() => {
                // update labels and charts after animation
                try {
                    document.getElementById('personal-goal-label').textContent = `${anim.newPersonal.toFixed(1)} / ${currentData.weekly_goal.toFixed(1)} kg`;
                    updateCharts(anim.newPersonal, currentData.weekly_goal, anim.newNeighborhood, currentData.neighborhood_goal_kg);
                } catch (e) {}
            });
        }

        function updateCharts(curKg, goalKg, hoodCur, hoodGoal) {
             const personalCtx = document.getElementById('personalGoalChart').getContext('2d');
             if (personalChart) personalChart.destroy(); 
             personalChart = new Chart(personalCtx, {
                 type: 'doughnut',
                 data: {
                     datasets: [{
                         data: [curKg, Math.max(0, goalKg - curKg)],
                         backgroundColor: ['#4CAF50', '#333'],
                         borderColor: ['#1e1e1e'],
                         borderWidth: 0
                     }]
                 },
                 options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { legend: { display: false }, tooltip: { enabled: false } } }
             });
             
             // Add Percentage Text
             let pPct = (curKg / goalKg) * 100;
             document.getElementById('personal-percent').textContent = `${pPct.toFixed(0)}%`;

             const neighborhoodCtx = document.getElementById('neighborhoodGoalChart').getContext('2d');
             if (neighborhoodChart) neighborhoodChart.destroy();
             neighborhoodChart = new Chart(neighborhoodCtx, {
                 type: 'doughnut',
                 data: {
                     datasets: [{
                         data: [hoodCur, Math.max(0, hoodGoal - hoodCur)],
                         backgroundColor: ['#0D47A1', '#333'],
                         borderColor: ['#1e1e1e'],
                         borderWidth: 0
                     }]
                 },
                 options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { legend: { display: false }, tooltip: { enabled: false } } }
             });
             
             let nPct = (hoodCur / hoodGoal) * 100;
             document.getElementById('neighborhood-percent').textContent = `${nPct.toFixed(1)}%`;
        }

        function renderActivityList() {
            const list = document.querySelector('.activity-list');
            if (!list) return;
            list.innerHTML = '';
            (currentData.activities || []).forEach(act => {
                const li = document.createElement('li');
                li.className = 'activity-item';
                const d = new Date(act.timestamp);
                const dateLabel = d.toLocaleDateString(undefined, { month: 'short', day: '2-digit', year: 'numeric' });
                
                // Color logic
                let amountClass = 'deposit';
                if (act.amount < 0) amountClass = 'withdrawal';
                if (act.amount === 0) amountClass = 'neutral'; // For the 0.00 withdrawal

                const amountText = (act.amount > 0 ? '+' : '') + act.amount.toFixed(2) + ' ECO';

                li.innerHTML = `
                    <span class="activity-date">${dateLabel}</span>
                    <span class="activity-desc">${act.desc}</span>
                    <span class="activity-amount ${amountClass}">${amountText}</span>
                `;
                list.appendChild(li);
            });
        }

        // --- EVENT LISTENERS ---
        document.getElementById('simulate-deposit-btn').addEventListener('click', handleDeposit);
        
        document.getElementById('modal-close-btn').addEventListener('click', function() {
            const successModalEl = document.getElementById('success-modal');
            if (successModalEl) {
                // hide and disable pointer events to ensure it can't block scrolling
                successModalEl.style.display = 'none';
                successModalEl.style.pointerEvents = 'none';
                successModalEl.style.visibility = 'hidden';
            }

            // Find possible scroll containers (document + main dashboard)
            const docEl = document.documentElement;
            const bodyEl = document.body;
            const mainDashboard = document.querySelector('.app-dashboard') || document.querySelector('main') || null;

            // Perform a fast, visible smooth-scroll UP so the user sees the motion,
            // then run the pending animations once the scroll completes.
            Promise.all([
                smoothScrollElementToTop(docEl, 420),
                smoothScrollElementToTop(bodyEl, 420)
            ]).then(() => {
                if (mainDashboard) return smoothScrollElementToTop(mainDashboard, 300);
            }).then(() => {
                // After the visible scroll completes, run the KPI animations
                return runPendingAnimations();
            }).then(() => {
                const firstKpi = document.getElementById('kpi-ecocoin');
                if (firstKpi && typeof firstKpi.focus === 'function') firstKpi.focus();
            }).finally(() => {
                // restore modal pointer handling shortly after animations
                setTimeout(() => {
                    if (successModalEl) {
                        successModalEl.style.pointerEvents = '';
                        successModalEl.style.visibility = '';
                    }
                }, 200);
            });
        });

        // Reset Button
        const resetBtn = document.getElementById('reset-demo-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                localStorage.removeItem('userBalance');
                sessionStorage.removeItem('demo_just_withdrew');
                location.reload();
            });
        }

        // Init
        initializeDashboard();
    });
</script>

        

        <div class="modal-overlay" id="success-modal">
        <div class="card modal-content success-modal-content">
            <canvas id="confetti-canvas"></canvas>
            <h2>Success!</h2>
            <p class="success-subtitle">A new drop-off has been verified.</p>
            
            <div class="reward-summary" style="padding: 0; border: none; background: none; margin-bottom: 1.5rem;">
                <p>Base Reward (10.0kg Cans): <span>500.00 ECO</span></p>
                <p>Neighborhood Bonus (2.5%): <span>+ 12.50 ECO</span></p>
                <p>Bronze Tier Bonus (1.0%): <span>+ 5.00 ECO</span></p>
                <hr>
                <p class="total" style="font-size: 1.5rem;">Total Payout: <span id="modal-eco-value">+518 ECO</span></p>
            </div>

            <button class="btn-primary-large btn-form" id="modal-close-btn">Awesome!</button>
        </div>
    </div>
    </body>
</html>