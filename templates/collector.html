<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collector Dashboard - VeriCycle</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
</head>
<body class="dark-theme">
    <header class="navbar">
        <div class="container">
            <h1 class="logo">VeriCycle</h1>
            <nav>
                <a href="/" class="nav-button">Log Out</a>
            </nav>
        </div>
    </header>

    <main class="container app-dashboard">
        <div class="dashboard-header">
            <h2>Welcome back, {{ current_user.email.split('@')[0] }}!</h2>
            <p>Here is your recycling progress.</p>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <span class="kpi-label">Total EcoCoin Earned</span>
                <h3 id="kpi-ecocoin">--</h3>
            </div>
            <div class="kpi-card">
                <span class="kpi-label">Total Kilograms Recycled</span>
                <h3 id="kpi-kg">--</h3>
            </div>
        </div>

        <div class="chart-grid">
            <div class="chart-card">
                <h3>Personal Goal</h3>
                <p class="chart-label" id="personal-goal-label">-- / -- kg</p>
                <canvas id="personalGoalChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Neighborhood Goal</h3>
                <p class="chart-label" id="neighborhood-goal-label">--%</p>
                <canvas id="neighborhoodGoalChart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <h3>Your Drop-off QR Code</h3>
            <p>Generate a unique code for the recycling center to scan.</p>
            <button class="btn-primary" id="generate-btn">Generate Drop-off QR Code</button>
            <div id="qr-code-container"></div>
        </div>

    </main>

    <script>
        // --- This function runs when the page is fully loaded ---
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- 1. FIRE THE CELEBRATION ---
            // We'll fire confetti right away!
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });

            // --- 2. YOUR ORIGINAL QR CODE LOGIC (UNCHANGED) ---
            const generateButton = document.getElementById('generate-btn');
            const qrContainer = document.getElementById('qr-code-container');

            generateButton.addEventListener('click', function() {
                qrContainer.innerHTML = ''; 
                const qrImage = document.createElement('img');
                qrImage.src = '/generate-qr?' + new Date().getTime();
                qrContainer.appendChild(qrImage);
            });

            // --- 3. NEW DASHBOARD LOGIC (FETCH DATA & BUILD CHARTS) ---
            
            // This function fetches data from your new API route
            async function loadDashboardData() {
                try {
                    const response = await fetch('/api/my-dashboard-data');
                    const data = await response.json();

                    // A. Populate the KPI Cards
                    document.getElementById('kpi-ecocoin').textContent = data.total_eco;
                    document.getElementById('kpi-kg').textContent = `${data.total_kg} kg`;

                    // B. Populate the Chart Labels
                    document.getElementById('personal-goal-label').textContent = `${data.current_kg} / ${data.weekly_goal} kg`;
                    document.getElementById('neighborhood-goal-label').textContent = `${data.neighborhood_goal_percent}%`;
                    
                    // C. Draw the Personal Goal Chart
                    const personalCtx = document.getElementById('personalGoalChart').getContext('2d');
                    new Chart(personalCtx, {
                        type: 'doughnut',
                        data: {
                            datasets: [{
                                data: [data.current_kg, data.weekly_goal - data.current_kg],
                                backgroundColor: ['#4CAF50', '#333'], // Green for progress, dark grey for remaining
                                borderColor: ['#1e1e1e'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            cutout: '80%', // This makes it an "Apple Ring"
                            plugins: {
                                legend: { display: false },
                                tooltip: { enabled: false }
                            }
                        }
                    });

                    // D. Draw the Neighborhood Goal Chart
                    const neighborhoodCtx = document.getElementById('neighborhoodGoalChart').getContext('2d');
                    new Chart(neighborhoodCtx, {
                        type: 'doughnut',
                        data: {
                            datasets: [{
                                data: [data.neighborhood_goal_percent, 100 - data.neighborhood_goal_percent],
                                backgroundColor: ['#0D47A1', '#333'], // Blue for progress, dark grey for remaining
                                borderColor: ['#1e1e1e'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            cutout: '80%', // This makes it an "Apple Ring"
                            plugins: {
                                legend: { display: false },
                                tooltip: { enabled: false }
                            }
                        }
                    });

                } catch (error) {
                    console.error('Error fetching dashboard data:', error);
                }
            }

            // Call the function to load everything!
            loadDashboardData();
        });
    </script>
</body>
</html>