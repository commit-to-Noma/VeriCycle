<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collector Dashboard - VeriCycle</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
</head>
<body class="dark-theme">
    {% include '_navbar.html' %}

    <main class="container app-dashboard">
        <div class="dashboard-header">
            <h2>Welcome back, {{ current_user.email.split('@')[0] }}!</h2>
            <p>Here is your recycling progress.</p>
        </div>

        <div class="dashboard-grid">
            
            <div class="kpi-card">
                <h3>
                    Total EcoCoin Earned
                    <span class="tooltip" data-tooltip="EcoCoin is your digital reward token, built on the Hedera network. It's a secure, verifiable asset you earn for recycling.">â“˜</span>
                </h3>
                <p class="kpi-value" id="kpi-ecocoin">--</p>
            </div>
            
            <div class="kpi-card">
                <h3>Total Kilograms Recycled</h3>
                <p class="kpi-value" id="kpi-kg">--</p>
            </div>

            <div class="chart-card">
                <h3>Personal Goal</h3>
                <p class="chart-label" id="personal-goal-label">-- / -- kg</p>
                
                <div class="chart-canvas-container">
                    <span class="chart-percentage" id="personal-percent">--%</span>
                    <canvas id="personalGoalChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3>Neighborhood Goal</h3>
                <p class="chart-label" id="neighborhood-goal-label">-- / -- kg</p>
                
                <div class="chart-canvas-container">
                    <span class="chart-percentage" id="neighborhood-percent">--%</span>
                    <canvas id="neighborhoodGoalChart"></canvas>
                </div>
            </div>
            
        </div>
        
    <!-- This is the new 2-column QR card -->
    <div class="card">
        <div class="qr-grid">

            <!-- Column 1: Instructions -->
            <div class="instructions">
                <h3>How to Drop Off:</h3>
                <ol>
                    <li>Press the "Generate" button below.</li>
                    <li>Show your unique QR code to the recycling center.</li>
                    <li>The center will scan your code and weigh your materials.</li>
                    <li>Your EcoCoin reward will be deposited instantly!</li>
                </ol>
                <button class="btn-primary" id="generate-btn">Generate Drop-off QR Code</button>
            </div>

            <!-- Column 2: The QR Code -->
            <div class="qr-code-container" id="qr-code-container">
                <p class="qr-placeholder">Your QR code will appear here once generated.</p>
            </div>

        </div>
    </div>

    <!-- This "Simulate" button is now at the bottom, separate -->
    <div class="card">
         <button class="btn-primary" id="simulate-deposit-btn" style="background-color: #0D47A1; width: 100%; box-sizing: border-box;">
            Simulate New Deposit (750 ECO)
        </button>
    </div>

    </main>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- 1. GLOBAL VARIABLES ---
        const generateButton = document.getElementById('generate-btn');
        const qrContainer = document.getElementById('qr-code-container');
        let personalChart = null;
        let neighborhoodChart = null;
        let currentData = {}; // Holds the current state of all data

        // --- 2. "SCROLLING NUMBER" ANIMATION FUNCTION (Unchanged) ---
        function animateValue(element, start, end, duration, suffix = '', decimals = 0) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                let currentValue = progress * (end - start) + start;
                element.textContent = currentValue.toFixed(decimals) + suffix;
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        // --- 3. QR CODE LOGIC (Unchanged) ---
        generateButton.addEventListener('click', function() {
            // --- PROFILE CHECK ---
            // We check here, right before generating
            if (!currentData.profile_complete) {
                alert("Please complete your profile before generating a QR code.");
                // We can also redirect them
                window.location.href = "/profile";
                return;
            }
            
            qrContainer.innerHTML = ''; 
            const qrImage = document.createElement('img');
            qrImage.src = '/generate-qr?' + new Date().getTime();
            qrContainer.appendChild(qrImage);
        });

        // --- 4. MAIN DATA LOADER & CHART BUILDER (FIXED) ---
        function drawDashboard(data) {
            try {
                // A. Populate the KPI Cards
                document.getElementById('kpi-ecocoin').textContent = data.total_eco;
                document.getElementById('kpi-kg').textContent = `${data.total_kg.toFixed(1)} kg`;

                // B. Populate the Chart Labels
                document.getElementById('personal-goal-label').textContent = `${data.current_kg.toFixed(1)} / ${data.weekly_goal.toFixed(1)} kg`;
                document.getElementById('neighborhood-goal-label').textContent = `${data.neighborhood_current_kg.toFixed(1)} / ${data.neighborhood_goal_kg.toFixed(1)} kg`;
                
                // C. Populate the Percentage text
                let personalPercent = (data.current_kg / data.weekly_goal) * 100;
                let neighborhoodPercent = (data.neighborhood_current_kg / data.neighborhood_goal_kg) * 100;
                document.getElementById('personal-percent').textContent = `${personalPercent.toFixed(0)}%`;
                document.getElementById('neighborhood-percent').textContent = `${neighborhoodPercent.toFixed(1)}%`; // Use 1 decimal for neighborhood

                // D. Draw the Personal Goal Chart (Code is now included)
                const personalCtx = document.getElementById('personalGoalChart').getContext('2d');
                if (personalChart) personalChart.destroy(); 
                personalChart = new Chart(personalCtx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [data.current_kg, Math.max(0, data.weekly_goal - data.current_kg)],
                            backgroundColor: ['#4CAF50', '#333'],
                            borderColor: ['#1e1e1e'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, cutout: '80%',
                        animation: { duration: 0 }, 
                        plugins: { legend: { display: false }, tooltip: { enabled: false } }
                    }
                });

                // E. Draw the Neighborhood Goal Chart (Code is now included)
                const neighborhoodCtx = document.getElementById('neighborhoodGoalChart').getContext('2d');
                if (neighborhoodChart) neighborhoodChart.destroy();
                neighborhoodChart = new Chart(neighborhoodCtx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [data.neighborhood_current_kg, Math.max(0, data.neighborhood_goal_kg - data.neighborhood_current_kg)],
                            backgroundColor: ['#0D47A1', '#333'],
                            borderColor: ['#1e1e1e'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, cutout: '80%',
                        animation: { duration: 0 },
                        plugins: { legend: { display: false }, tooltip: { enabled: false } }
                    }
                });
            } catch (e) {
                console.error("Error in drawDashboard:", e);
            }
        }

        // --- 5. LOCALSTORAGE DATA HANDLER (FIXED) ---
        async function initializeDashboard() {
            try {
                let storedData = localStorage.getItem('userBalance');
                
                if (storedData) {
                    currentData = JSON.parse(storedData);
                } else {
                    const response = await fetch('/api/my-dashboard-data');
                    currentData = await response.json(); 
                    // Also fetch profile status
                    currentData.profile_complete = "{{ 1 if current_user.full_name and current_user.id_number else 0 }}";
                    localStorage.setItem('userBalance', JSON.stringify(currentData));
                }
                
                drawDashboard(currentData);

            } catch (e) {
                console.error("Error initializing dashboard:", e);
            }
        }

        // --- 6. SUCCESS MODAL FUNCTIONS (Unchanged) ---
        const successModal = document.getElementById('success-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const simulateBtn = document.getElementById('simulate-deposit-btn');
        const confettiCanvas = document.getElementById('confetti-canvas');
        const modalConfetti = confetti.create(confettiCanvas, { resize: true, useWorker: true });

        function showSuccessModal(eco, kg) {
            document.getElementById('modal-eco-value').textContent = `+${eco}`;
            document.getElementById('modal-kg-value').textContent = `+${kg.toFixed(1)} kg`;
            successModal.style.display = 'flex';
            modalConfetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }
        function hideSuccessModal() {
            successModal.style.display = 'none';
        }

        // --- 7. EVENT LISTENERS (FIXED) ---
        simulateBtn.addEventListener('click', function() {
            showSuccessModal(750, 15.0);
        });

        modalCloseBtn.addEventListener('click', function() {
            hideSuccessModal();

            const newEco = 750;
            const newKg = 15.0;

            let oldEco = currentData.total_eco;
            let oldKg = currentData.total_kg;
            let oldPersonalKg = currentData.current_kg;
            let oldNeighborhoodKg = currentData.neighborhood_current_kg;
            let oldPersonalPercent = (oldPersonalKg / currentData.weekly_goal) * 100;
            let oldNeighborhoodPercent = (oldNeighborhoodKg / currentData.neighborhood_goal_kg) * 100;

            let newTotalEco = oldEco + newEco;
            let newTotalKg = oldKg + newKg;
            let newPersonalKg = oldPersonalKg + newKg;
            let newNeighborhoodKg = oldNeighborhoodKg + newKg;
            let newPersonalPercent = (newPersonalKg / currentData.weekly_goal) * 100;
            let newNeighborhoodPercent = (newNeighborhoodKg / currentData.neighborhood_goal_kg) * 100;

            animateValue(document.getElementById('kpi-ecocoin'), oldEco, newTotalEco, 1500, '', 0); 
            animateValue(document.getElementById('kpi-kg'), oldKg, newTotalKg, 1500, ' kg', 1);
            animateValue(document.getElementById('personal-percent'), oldPersonalPercent, newPersonalPercent, 1500, '%', 0); 
            animateValue(document.getElementById('neighborhood-percent'), oldNeighborhoodPercent, newNeighborhoodPercent, 1500, '%', 1); 

            document.getElementById('personal-goal-label').textContent = `${newPersonalKg.toFixed(1)} / ${currentData.weekly_goal.toFixed(1)} kg`;
            document.getElementById('neighborhood-goal-label').textContent = `${newNeighborhoodKg.toFixed(1)} / ${currentData.neighborhood_goal_kg.toFixed(1)} kg`;

            personalChart.data.datasets[0].data = [newPersonalKg, Math.max(0, currentData.weekly_goal - newPersonalKg)];
            neighborhoodChart.data.datasets[0].data = [newNeighborhoodKg, Math.max(0, currentData.neighborhood_goal_kg - newNeighborhoodKg)];
            personalChart.update();
            neighborhoodChart.update();

            currentData.total_eco = newTotalEco;
            currentData.total_kg = newTotalKg;
            currentData.current_kg = newPersonalKg;
            currentData.neighborhood_current_kg = newNeighborhoodKg;
            localStorage.setItem('userBalance', JSON.stringify(currentData)); 
        });

        // --- 8. INITIAL PAGE LOAD ---
        initializeDashboard();
    });
</script>

    <div class="modal-overlay" id="success-modal">
        <div class="card modal-content success-modal-content">
            <canvas id="confetti-canvas"></canvas>
            <h2>Success!</h2>
            <p class="success-subtitle">A new drop-off has been verified.</p>
            
            <div class="success-kpis">
                <div class="success-kpi">
                    <span class="success-label">EcoCoin Earned</span>
                    <span class="success-value" id="modal-eco-value">+0</span>
                </div>
                <div class="success-kpi">
                    <span class="success-label">Kilograms Recycled</span>
                    <span class="success-value" id="modal-kg-value">+0 kg</span>
                </div>
            </div>

            <button class="btn-primary-large btn-form" id="modal-close-btn">Awesome!</button>
        </div>
    </div>
    </body>
</html>