<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collector Dashboard - VeriCycle</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
</head>
<body class="dark-theme">
    {% include '_navbar.html' %}

    <main class="container app-dashboard">
        <div class="dashboard-header">
            <h2>Welcome back, {{ current_user.email.split('@')[0] }}!</h2>
            <p>Here is your recycling progress.</p>
        </div>

        <div class="dashboard-grid">
            
            <div class="kpi-card">
                <h3>
                    Current EcoCoin Balance
                    <span class="tooltip" data-tooltip="This shows your current account balance available to spend or withdraw.">â“˜</span>
                </h3>
                <p class="kpi-value" id="kpi-ecocoin">--</p>
                
                <a href="{{ url_for('swap') }}" class="btn-primary" style="width: 100%; box-sizing: border-box; margin-top: 1.5rem; text-align: center;">
                    My Wallet & Redeem
                </a>
            </div>
            
            <div class="kpi-card">
                <h3>Total Kilograms Recycled</h3>
                <p class="kpi-value" id="kpi-kg">--</p>
            </div>

            <div class="chart-card">
                <h3>Personal Goal</h3>
                <p class="chart-label" id="personal-goal-label">-- / -- kg</p>
                
                <div class="chart-canvas-container">
                    <span class="chart-percentage" id="personal-percent">--%</span>
                    <canvas id="personalGoalChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3>
                    Neighborhood Goal
                    <span class="tooltip" data-tooltip="Your neighborhood (Sandton) is a high-activity area, so you earn a +2.5% bonus on all EcoCoin payouts!">â“˜</span>
                </h3>
                <p class="chart-label" id="neighborhood-goal-label">-- / -- kg</p>
                
                <div class="chart-canvas-container">
                    <span class="chart-percentage" id="neighborhood-percent">--%</span>
                    <canvas id="neighborhoodGoalChart"></canvas>
                </div>
                </div>

            <div class="card proof-income" style="grid-column: 1 / -1; display: flex; align-items: center; justify-content: space-between; padding: 1.5rem; min-height: 0; height: auto;">
                <div>
                    <h3 style="margin-bottom: 0.25rem;">Proof of Income Report</h3>
                    <p style="color: #aaa; margin: 0; font-size: 0.9rem;">Download your official verified transaction history.</p>
                </div>
                <a href="{{ url_for('static', filename='sample_report.pdf') }}" target="_blank" class="btn-secondary" style="margin-top: 0;">
                    Download PDF ðŸ“„
                </a>
            </div>

            <div class="card" id="activity-section" style="grid-column: 1 / -1; margin-top: 0;">
                <h3>Recent Activity</h3>
                <p class="mockup-subtitle">Your HCS-verified transaction log.</p>
                
                <ul class="activity-list">
                </ul>
            </div>

        </div>

    <!-- This is the new 2-column QR card -->
    <div class="card">
        <div class="qr-grid">

            <div class="instructions">
                <h3>How to Drop Off:</h3>
                <ol>
                    <li>Press the "Generate" button below.</li>
                    <li>Show your unique QR code to the recycling center.</li>
                    <li>The center will scan your code and weigh your materials.</li>
                    <li>Your EcoCoin reward will be deposited instantly!</li>
                </ol>
                <button class="btn-primary" id="generate-btn">Generate Drop-off QR Code</button>
            </div>
            
            <div class="qr-code-container" id="qr-code-container">
                <div class="qr-placeholder">
                    Click "Generate" to create your code
                </div>
            </div>

        </div> </div>

    

    <a href="{{ url_for('request_pickup') }}" class="pickup-card-link">
        <div class="card pickup-card">
            <div class="pickup-icon">ðŸšš</div>
            <div class="pickup-text">
                <h3>Request a Pickup</h3>
                <p>Have too much to drop off? Schedule a pickup from your location.</p>
            </div>
            <div class="pickup-arrow">â€º</div>
        </div>
    </a>

    <div class="card" id="faq-section">
        <h3>Need Help?</h3>
        <p class="mockup-subtitle">Find answers to common questions about your dashboard.</p>
        
        <div class="faq-grid">
            <ul class="faq-list">
                <li><a href="#">How is my "Total EcoCoin" calculated?</a></li>
                <li><a href="#">What is a "Personal Goal"?</a></li>
                <li><a href="#">Why hasn't my drop-off appeared yet?</a></li>
                <li><a href="#">How do I find my Hedera wallet keys?</a></li>
            </ul>
            <ul class="faq-list">
                <li><a href="#">What is the "Neighborhood Goal"?</a></li>
                <li><a href="#">How do I redeem my EcoCoin for ZAR?</a></li>
                <li><a href="#">Can I change my weekly goal?</a></li>
                <li><a href="#">How do I update my profile information?</a></li>
            </ul>
        </div>
    </div>

    

    <div class="card" style="background-color: #333; border: 1px solid #E57373;">
         <button class="btn-primary" id="simulate-deposit-btn" style="background-color: #0D47A1; width: 100%; box-sizing: border-box;">
            Refresh Balance (Simulate Scan)
        </button>
        {% if current_user.email.lower() == 'demo@vericycle.com' %}
        <button class="btn-secondary" id="reset-demo-btn" style="width: 100%; box-sizing: border-box; margin-top: 1rem; border-color: #E57373; color: #E57373;">
            Reset Demo
        </button>
        {% endif %}
    </div>

    </main>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- BROADCAST LISTENER (Auto-update) ---
        const channel = new BroadcastChannel('vericycle_demo');
        channel.onmessage = (event) => {
            if (event.data.type === 'DEPOSIT') {
                // Trigger the button click automatically!
                const btn = document.getElementById('simulate-deposit-btn');
                if (btn) btn.click();
            }
        };

        // --- 1. GLOBAL VARIABLES ---
        const generateButton = document.getElementById('generate-btn');
        const qrContainer = document.getElementById('qr-code-container');
        let personalChart = null;
        let neighborhoodChart = null;
        let currentData = {}; // Holds the current state of all data

        // --- NEW: "MAGIC RESET" BUTTON (uses session flag) ---
        const resetBtn = document.getElementById('reset-demo-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                // Clear the bad data
                localStorage.removeItem('userBalance'); 
                // Set a flag so the page knows to fetch clean data
                sessionStorage.setItem('demo_just_reset', 'true'); 
                // Reload the page
                location.reload(); 
            });
        }

        // --- 2. "SCROLLING NUMBER" ANIMATION FUNCTION (Unchanged) ---
        function animateValue(element, start, end, duration, suffix = '', decimals = 0) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                let currentValue = progress * (end - start) + start;
                element.textContent = currentValue.toFixed(decimals) + suffix;
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        // --- 3. QR CODE LOGIC (Unchanged) ---
        generateButton.addEventListener('click', function() {
            // --- PROFILE CHECK ---
            // We check here, right before generating
            if (!currentData.profile_complete) {
                alert("Please complete your profile before generating a QR code.");
                // We can also redirect them
                window.location.href = "/profile";
                return;
            }
            
            qrContainer.innerHTML = ''; 
            const qrImage = document.createElement('img');
            qrImage.src = '/generate-qr?' + new Date().getTime();
            qrContainer.appendChild(qrImage);
        });

        // --- 4. MAIN DATA LOADER & CHART BUILDER (FIXED) ---
        function drawDashboard(data) {
            try {
                // A. Populate the KPI Cards
                document.getElementById('kpi-ecocoin').textContent = data.total_eco;
                document.getElementById('kpi-kg').textContent = `${data.total_kg.toFixed(1)} kg`;

                // B. Populate the Chart Labels
                document.getElementById('personal-goal-label').textContent = `${data.current_kg.toFixed(1)} / ${data.weekly_goal.toFixed(1)} kg`;
                document.getElementById('neighborhood-goal-label').textContent = `${data.neighborhood_current_kg.toFixed(1)} / ${data.neighborhood_goal_kg.toFixed(1)} kg`;
                
                // C. Populate the Percentage text
                let personalPercent = (data.current_kg / data.weekly_goal) * 100;
                let neighborhoodPercent = (data.neighborhood_current_kg / data.neighborhood_goal_kg) * 100;
                document.getElementById('personal-percent').textContent = `${personalPercent.toFixed(0)}%`;
                document.getElementById('neighborhood-percent').textContent = `${neighborhoodPercent.toFixed(1)}%`; // Use 1 decimal for neighborhood

                // D. Draw the Personal Goal Chart (Code is now included)
                const personalCtx = document.getElementById('personalGoalChart').getContext('2d');
                if (personalChart) personalChart.destroy(); 
                personalChart = new Chart(personalCtx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [data.current_kg, Math.max(0, data.weekly_goal - data.current_kg)],
                            backgroundColor: ['#4CAF50', '#333'],
                            borderColor: ['#1e1e1e'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, cutout: '80%',
                        animation: { duration: 0 }, 
                        plugins: { legend: { display: false }, tooltip: { enabled: false } }
                    }
                });

                // E. Draw the Neighborhood Goal Chart (Code is now included)
                const neighborhoodCtx = document.getElementById('neighborhoodGoalChart').getContext('2d');
                if (neighborhoodChart) neighborhoodChart.destroy();
                neighborhoodChart = new Chart(neighborhoodCtx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [data.neighborhood_current_kg, Math.max(0, data.neighborhood_goal_kg - data.neighborhood_current_kg)],
                            backgroundColor: ['#0D47A1', '#333'],
                            borderColor: ['#1e1e1e'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, cutout: '80%',
                        animation: { duration: 0 },
                        plugins: { legend: { display: false }, tooltip: { enabled: false } }
                    }
                });
            } catch (e) {
                console.error("Error in drawDashboard:", e);
            }
        }

        // Render the Recent Activity list from currentData.activities
        function renderActivityList() {
            try {
                const list = document.querySelector('#activity-section .activity-list');
                if (!list) return;
                const activities = currentData.activities || [];

                // If there are no activities in currentData, try to rehydrate from localStorage
                if (!activities || activities.length === 0) {
                    try {
                        const stored = localStorage.getItem('userBalance');
                        if (stored) {
                            const parsed = JSON.parse(stored);
                            if (parsed && Array.isArray(parsed.activities) && parsed.activities.length > 0) {
                                currentData.activities = parsed.activities;
                            }
                        }
                    } catch (e) {
                        console.error('Error rehydrating activities from cache:', e);
                    }
                }

                const finalActivities = (currentData.activities || []);
                if (!finalActivities || finalActivities.length === 0) {
                    // No activities to render; keep any existing static markup in DOM
                    return;
                }
                list.innerHTML = '';
                finalActivities.forEach(act => {
                    const li = document.createElement('li');
                    li.className = 'activity-item';

                    // Determine display date (time if today, else date)
                    const d = new Date(act.timestamp);
                    const today = new Date();
                    const isToday = d.toDateString() === today.toDateString();
                    const dateLabel = isToday ? d.toTimeString().substring(0,5) : d.toLocaleDateString(undefined, { month: 'short', day: '2-digit', year: 'numeric' });

                    const amountClass = act.amount < 0 ? 'withdrawal' : 'deposit';
                    const amountText = (act.amount < 0 ? act.amount.toFixed(2) : ('+' + act.amount.toFixed(2))) + ' ECO';

                    li.innerHTML = `
                        <span class="activity-date">${dateLabel}</span>
                        <span class="activity-desc">${act.desc}</span>
                        <span class="activity-amount ${amountClass}">${amountText}</span>
                    `;
                    list.appendChild(li);
                });
            } catch (e) {
                console.error('Error rendering activity list', e);
            }
        }

        // --- 5. LOCALSTORAGE DATA HANDLER (NEW, SIMPLIFIED) ---
        async function initializeDashboard() {
            try {
                // Check if we just clicked the "Reset" button
                const justReset = sessionStorage.getItem('demo_just_reset');

                let storedData = localStorage.getItem('userBalance');

                // If we clicked "Reset" OR there is no stored data, fetch the clean data
                if (justReset || !storedData) {
                    sessionStorage.removeItem('demo_just_reset'); // Clear the flag
                    const response = await fetch('/api/my-dashboard-data');
                    if (!response.ok) throw new Error('Network response was not ok');

                    currentData = await response.json(); // This is the clean, 2-item list from app.py

                    // --- CLEAN STATE FIX ---
                    if (currentData.force_reset) {
                        localStorage.removeItem('userBalance');
                    }
                    // -----------------------

                    localStorage.setItem('userBalance', JSON.stringify(currentData));

                } else {
                    // Otherwise, just load the data we already have
                    currentData = JSON.parse(storedData);
                }

                // --- THIS IS THE FIX ---
                // If we just performed a swap (deduction), apply that flag first
                const swapFlag = sessionStorage.getItem('demo_just_swapped');
                if (swapFlag) {
                    try {
                        const swapData = JSON.parse(swapFlag);
                        currentData.activities = currentData.activities || [];
                        currentData.activities.unshift({
                            timestamp: new Date().toISOString(),
                            desc: swapData.desc,
                            amount: swapData.amount
                        });
                        sessionStorage.removeItem('demo_just_swapped');
                        localStorage.setItem('userBalance', JSON.stringify(currentData));
                    } catch (e) {
                        console.error('Error applying swap flag:', e);
                    }
                }

                // Then apply a withdrawal flag (so withdrawal appears after the swap)
                const withdrawalFlag = sessionStorage.getItem('demo_just_withdrew');
                if (withdrawalFlag) {
                    try {
                        const withdrawalData = JSON.parse(withdrawalFlag);
                        currentData.activities = currentData.activities || [];
                        currentData.activities.unshift({
                            timestamp: new Date().toISOString(),
                            desc: withdrawalData.desc,
                            amount: withdrawalData.amount
                        });
                        sessionStorage.removeItem('demo_just_withdrew');
                        localStorage.setItem('userBalance', JSON.stringify(currentData));
                    } catch (e) {
                        console.error('Error applying withdrawal flag:', e);
                    }
                }

                drawDashboard(currentData);
                renderActivityList(); 

            } catch (e) {
                console.error("Error initializing dashboard:", e);
            }
        }

        // --- 6. SUCCESS MODAL FUNCTIONS (Updated) ---
        const successModal = document.getElementById('success-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const simulateBtn = document.getElementById('simulate-deposit-btn');
        const confettiCanvas = document.getElementById('confetti-canvas');
        const modalConfetti = confetti.create(confettiCanvas, { resize: true, useWorker: true });
        function showSuccessModal(kg) {
            // The EcoCoin value is now part of the HTML
            // We just need to update the modal subtitle
            document.querySelector('#success-modal .success-subtitle').textContent = `A new drop-off of ${kg.toFixed(1)}kg has been verified.`;
            successModal.style.display = 'flex';
            modalConfetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }
        function hideSuccessModal() {
            successModal.style.display = 'none';
        }

        // --- 7. EVENT LISTENERS (FIXED) ---
        simulateBtn.addEventListener('click', function() {
            showSuccessModal(10.0);
        });

        modalCloseBtn.addEventListener('click', function() {
            hideSuccessModal();

            const newEco = 518; 
            const newKg = 10.0;

            // --- 1. Create the new activity object ---
            const activityObj = {
                timestamp: new Date().toISOString(),
                desc: `Verified Drop-off (${newKg.toFixed(1)}kg of Cans)`,
                amount: newEco
            };

            // --- 2. Animate the numbers (your existing logic) ---
            let oldEco = currentData.total_eco;
            let oldKg = currentData.total_kg;
            let oldPersonalKg = currentData.current_kg;
            let oldNeighborhoodKg = currentData.neighborhood_current_kg;
            let oldPersonalPercent = (oldPersonalKg / currentData.weekly_goal) * 100;
            let oldNeighborhoodPercent = (oldNeighborhoodKg / currentData.neighborhood_goal_kg) * 100;

            let newTotalEco = oldEco + newEco;
            let newTotalKg = oldKg + newKg;
            let newPersonalKg = oldPersonalKg + newKg;
            let newNeighborhoodKg = oldNeighborhoodKg + newKg;
            let newPersonalPercent = (newPersonalKg / currentData.weekly_goal) * 100;
            let newNeighborhoodPercent = (newNeighborhoodKg / currentData.neighborhood_goal_kg) * 100;

            animateValue(document.getElementById('kpi-ecocoin'), oldEco, newTotalEco, 1500, '', 0); 
            animateValue(document.getElementById('kpi-kg'), oldKg, newTotalKg, 1500, ' kg', 1);
            animateValue(document.getElementById('personal-percent'), oldPersonalPercent, newPersonalPercent, 1500, '%', 0); 
            animateValue(document.getElementById('neighborhood-percent'), oldNeighborhoodPercent, newNeighborhoodPercent, 1500, '%', 1); 

            // --- 3. Update the labels ---
            document.getElementById('personal-goal-label').textContent = `${newPersonalKg.toFixed(1)} / ${currentData.weekly_goal.toFixed(1)} kg`;
            document.getElementById('neighborhood-goal-label').textContent = `${newNeighborhoodKg.toFixed(1)} / ${currentData.neighborhood_goal_kg.toFixed(1)} kg`;
            personalChart.data.datasets[0].data = [newPersonalKg, Math.max(0, currentData.weekly_goal - newPersonalKg)];
            neighborhoodChart.data.datasets[0].data = [newNeighborhoodKg, Math.max(0, currentData.neighborhood_goal_kg - newNeighborhoodKg)];
            personalChart.update();
            neighborhoodChart.update();

            // --- 4. Save the new data to localStorage (THIS IS THE FIX) ---
            currentData.total_eco = newTotalEco;
            currentData.total_kg = newTotalKg;
            currentData.current_kg = newPersonalKg;
            currentData.neighborhood_current_kg = newNeighborhoodKg;
            
            // Add the new activity to the start of the list
            currentData.activities = currentData.activities || [];
            currentData.activities.unshift(activityObj); 
            
            // Save the *entire* new state
            localStorage.setItem('userBalance', JSON.stringify(currentData)); 

            // --- 5. Re-render the activity list ---
            renderActivityList(); // This will now render all 3 items

            // --- 6. Scroll and show banner ---
            window.scrollTo({ top: 0, behavior: 'smooth' });
            // ... (show banner code is fine) ...
        });

        // --- 8. INITIAL PAGE LOAD ---
        initializeDashboard();
    });
</script>

        

        <div class="modal-overlay" id="success-modal">
        <div class="card modal-content success-modal-content">
            <canvas id="confetti-canvas"></canvas>
            <h2>Success!</h2>
            <p class="success-subtitle">A new drop-off has been verified.</p>
            
            <div class="reward-summary" style="padding: 0; border: none; background: none; margin-bottom: 1.5rem;">
                <p>Base Reward (10.0kg Cans): <span>500.00 ECO</span></p>
                <p>Neighborhood Bonus (2.5%): <span>+ 12.50 ECO</span></p>
                <p>Bronze Tier Bonus (1.0%): <span>+ 5.00 ECO</span></p>
                <hr>
                <p class="total" style="font-size: 1.5rem;">Total Payout: <span id="modal-eco-value">+518 ECO</span></p>
            </div>

            <button class="btn-primary-large btn-form" id="modal-close-btn">Awesome!</button>
        </div>
    </div>
    </body>
</html>