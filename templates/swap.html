<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet & Exchange - VeriCycle</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Lock scrolling ONLY on this page to keep the "App" feel */
        html, body {
            height: 100vh;
            overflow: hidden;
        }
    </style>
</head>
<body class="dark-theme">
    {% include '_navbar.html' %}

    <main class="container-wide app-dashboard">
        
        <div class="swap-header-row">
            <div class="page-title">
                <h2>Wallet & Exchange</h2>
                <p>Manage your earnings and cash out to your bank.</p>
            </div>
            <a href="{{ url_for('collector_dashboard') }}" class="back-link">‚Üê Back to Dashboard</a>
        </div>

        <div class="fintech-grid">
            
            <aside class="fintech-sidebar">
                
                <div class="card glass-card tier-panel">
                    <div class="panel-header">
                        <h3>üèÜ Membership Status</h3>
                        <span class="badge-tier bronze">Bronze</span>
                    </div>
                    <div class="tier-progress-container">
                        <div class="tier-labels">
                            <span>Progress</span>
                            <span>15 / 50 kg</span>
                        </div>
                        <div class="progress-track">
                            <div class="progress-fill" style="width: 30%;"></div>
                        </div>
                        <p class="next-tier-text">35kg to <strong>Silver</strong> (+1.5%)</p>
                    </div>
                    <div class="tier-benefit-row">
                        <span class="icon">‚ú®</span>
                        <span class="text">Active Bonus: <strong>+1.0%</strong></span>
                    </div>
                </div>

                <div class="card glass-card market-panel">
                    <div class="panel-header">
                        <h3>üìâ Live Market</h3>
                        <span class="live-dot">‚óè Live</span> </div>

                    <div class="market-list">
                        <div class="market-row highlight">
                            <div class="pair-group">
                                <div class="icon-pair">
                                    <span class="coin-icon eco">E</span>
                                    <span class="coin-icon hbar">H</span>
                                </div>
                                <div class="pair-text">
                                    <span class="pair-name">ECO / HBAR</span>
                                    <span class="pair-vol">Best Value</span>
                                </div>
                            </div>
                            <div class="pair-price">
                                <span class="price-val">0.0202</span>
                                <span class="price-change up">+1.2%</span>
                            </div>
                        </div>
                        <div class="market-row">
                            <div class="pair-group">
                                <div class="icon-pair">
                                    <span class="coin-icon hbar">H</span>
                                    <span class="coin-icon zar">Z</span>
                                </div>
                                <div class="pair-text">
                                    <span class="pair-name">HBAR / ZAR</span>
                                </div>
                            </div>
                            <div class="pair-price">
                                <span class="price-val">1.82</span>
                                <span class="price-change up">+0.5%</span>
                            </div>
                        </div>
                        <div class="market-row">
                            <div class="pair-group">
                                <div class="icon-pair">
                                    <span class="coin-icon eco">E</span>
                                    <span class="coin-icon usdc">$</span>
                                </div>
                                <div class="pair-text">
                                    <span class="pair-name">ECO / USDC</span>
                                </div>
                            </div>
                            <div class="pair-price">
                                <span class="price-val">0.0018</span>
                                <span class="price-change neutral">0.0%</span>
                            </div>
                        </div>
                        <div class="market-row">
                            <div class="pair-group">
                                <div class="icon-pair">
                                    <span class="coin-icon hbar">H</span>
                                    <span class="coin-icon btc">‚Çø</span>
                                </div>
                                <div class="pair-text">
                                    <span class="pair-name">HBAR / BTC</span>
                                </div>
                            </div>
                            <div class="pair-price">
                                <span class="price-val">0.000001</span>
                                <span class="price-change down">-0.2%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <section class="fintech-main">
                <div class="card glass-card exchange-panel">
                    
                    <div class="exchange-header-block">
                        <h3>üí± Exchange & Withdraw</h3>
                        <p class="exchange-subtitle">
                            üí° <strong>Tip:</strong> Swapping to a liquid asset like <strong>HBAR</strong> is recommended for the lowest fees, but you can choose other pairs below.
                        </p>
                    </div>

                    <div class="exchange-steps">
                        
                        <div class="step-box active">
                            <div class="step-label">
                                <span class="step-num">1</span>
                                <span>Swap ECO to HBAR</span>
                                <span class="wallet-bal">Bal: 1175 ECO</span>
                            </div>
                            
                            <div class="input-group-premium">
                                <div class="input-field">
                                    <label>You Pay</label>
                                    <input type="number" id="ecoInput" placeholder="0.00">
                                </div>
                                <div class="currency-selector">ECO</div>
                            </div>

                            <div class="exchange-arrow">‚Üì</div>

                            <div class="input-group-premium locked">
                                <div class="input-field">
                                    <label>You Receive</label>
                                    <input type="text" id="hbarOutput" readonly placeholder="0.0000">
                                </div>
                                <div class="currency-selector">HBAR <span style="font-size:0.7rem; margin-left:4px;">‚ñº</span></div>
                            </div>

                            <button id="swapBtn" class="btn-glow-green">Swap Now</button>
                        </div>

                        <div class="step-box disabled" id="step2-container">
                            <div class="step-label">
                                <span class="step-num">2</span>
                                <span>Withdraw to Bank</span>
                            </div>
                            <div class="input-group-premium locked">
                                <div class="input-field">
                                    <label>Total Cashout</label>
                                    <input type="text" id="zarOutput" readonly placeholder="ZAR 0.00">
                                </div>
                                <div class="currency-selector">ZAR <span style="font-size:0.7rem; margin-left:4px;">‚ñº</span></div>
                            </div>
                            <button id="withdrawBtn" class="btn-glow-blue" disabled>Withdraw to Bank</button>
                        </div>

                    </div>
                </div>
            </section>

        </div>
    </main>

    <div class="modal-overlay" id="tx-success-modal" style="display:none;">
        <div class="card modal-content success-modal-content">
            <h2>Success!</h2>
            <p id="tx-success-msg" class="success-subtitle">Transaction Complete.</p>
            <button class="btn-primary-large btn-form" id="tx-modal-close">Continue</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const RATE_ECO_HBAR = 0.0202;
        const RATE_HBAR_ZAR = 1.82;

        const ecoInput = document.getElementById('ecoInput');
        const hbarOutput = document.getElementById('hbarOutput');
        const zarOutput = document.getElementById('zarOutput');
        const swapBtn = document.getElementById('swapBtn');
        const withdrawBtn = document.getElementById('withdrawBtn');
        const step2 = document.getElementById('step2-container');
        
        // Modal Logic
        const txModal = document.getElementById('tx-success-modal');
        const txMsg = document.getElementById('tx-success-msg');
        const txClose = document.getElementById('tx-modal-close');
        let redirectAfter = false;

        function showModal(msg, shouldRedirect) {
            txMsg.textContent = msg;
            redirectAfter = shouldRedirect;
            txModal.style.display = 'flex';
        }

        txClose.addEventListener('click', () => {
            txModal.style.display = 'none';
            if (redirectAfter) window.location.href = "{{ url_for('collector_dashboard') }}";
        });

        ecoInput.addEventListener('input', function() {
            const val = parseFloat(this.value);
            if (val && val > 0) {
                const hbar = val * RATE_ECO_HBAR;
                hbarOutput.value = hbar.toFixed(4);
                const zar = hbar * RATE_HBAR_ZAR;
                zarOutput.value = "R " + zar.toFixed(2);
            } else {
                hbarOutput.value = "";
                zarOutput.value = "";
            }
        });

        swapBtn.addEventListener('click', function() {
            if(!ecoInput.value) return;
            swapBtn.textContent = "Swapping...";
            
            // Save Swap Flag
            const amount = parseFloat(ecoInput.value);
            const swapDetails = {
                desc: `Swap (${amount.toFixed(2)} ECO for ${hbarOutput.value} HBAR)`,
                amount: -amount
            };
            sessionStorage.setItem('demo_just_swapped', JSON.stringify(swapDetails));

            setTimeout(() => {
                swapBtn.textContent = "Done ‚úì";
                swapBtn.disabled = true;
                swapBtn.style.background = "#333";
                step2.classList.remove('disabled');
                step2.classList.add('active');
                withdrawBtn.disabled = false;
            }, 800);
        });

        withdrawBtn.addEventListener('click', function() {
            withdrawBtn.textContent = "Processing...";

            // Save Withdrawal Flags for Dashboard
            const swapVal = 820.00; // Hardcoded for perfect demo consistency
            const hbarVal = 16.6187;
            
            const withdrawalData = {
                swapAmount: swapVal,
                swapDesc: `Swap (${swapVal.toFixed(2)} ECO for ${hbarVal.toFixed(4)} HBAR)`,
                withdrawDesc: `Withdrawal (${hbarVal.toFixed(4)} HBAR to bank)`
            };
            sessionStorage.setItem('demo_just_withdrew', JSON.stringify(withdrawalData));

            setTimeout(() => {
                showModal("Withdrawal Successful! Funds sent to linked bank account.", true);
            }, 800);
        });
    });
    </script>
</body>
</html>
