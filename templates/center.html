<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Center Dashboard - VeriCycle</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="dark-theme">
    
    {% include '_navbar.html' %}

    <main class="container app-dashboard" style="overflow:visible;">
        <a href="{{ url_for('collector_dashboard') }}" class="back-link">‚Üê Back to Dashboard</a>
        <div class="dashboard-header">
            <h2>Center Dashboard</h2>
            <p>Welcome, {{ current_user.email.split('@')[0] }}! Verify drop-offs and manage transactions.</p>
        </div>

        <div class="card">
            <h3>Verify a Drop-off</h3>
            <p>Click the button to simulate scanning a collector's QR code. We will use the demo user (`test@gmail.com`) for this hackathon.</p>
            
            <form id="verify-form" action="{{ url_for('confirm_dropoff') }}" method="POST" class="verify-form">
                <input type="hidden" id="collector-id-scan" name="collector_id" value="0.0.7267109"> 
                
                <button type="button" class="btn-primary-large btn-form" id="scan-btn">
                    üì∑ Scan Collector QR Code
                </button>

                <div id="scan-results" style="display: none;">
                    <div class="form-group">
                        <label>Collector Found:</label>
                        <input type="text" value="Demo User (0.0.7267109)" disabled>
                    </div>
                    
                    <div class="form-group">
                        <label for="material-type">Material Type:</label>
                        <select id="material-type" name="material" required>
                            <option value="" disabled selected>-- Select Material --</option>
                            <option value="cans">Cans (50 ECO/kg)</option>
                            <option value="paper">Paper (30 ECO/kg)</option>
                            <option value="glass">Glass (20 ECO/kg)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="weight-kg">Material Weight (kg):</label>
                        <input type="number" id="weight-kg" name="weight" step="0.1" placeholder="e.g., 7.5" required>
                    </div>

                    <div class="reward-summary" id="reward-summary" style="display: none;">
                        <p>Base Reward: <span id="reward-base">--</span></p>
                        <p>Neighborhood Bonus (2.5%): <span id="reward-hood">+ --</span></p>
                        <p>Bronze Tier Bonus (1.0%): <span id="reward-tier">+ --</span></p>
                        <hr>
                        <p class="total">Total Payout: <span id="reward-total">--</span></p>
                    </div>
                    
                    <button type="submit" class="btn-primary-large btn-form" id="verify-btn" disabled>
                        Enter Weight & Material
                    </button>
                </div>

            </form>
        </div>

        <div class="card">
            <h3>Recent Verifications</h3>
            <div class="location-list" id="verification-list">
                <h4 class="verification-date-header" id="today-header">Today</h4>
                <ul id="today-list">
                    </ul>
    
                <h4 class="verification-date-header">Yesterday, November 17, 2025</h4>
                <ul>
                    <li>
                        <div class="tx-info">
                            <span class="tx-time">14:32</span>
                            <div class="tx-details">
                                <strong>Ed Marquez</strong> <span class="tx-id">(0.0.482910)</span><br>
                                <span class="tx-meta">15.0kg of Cans</span>
                            </div>
                        </div>
                        <span class="loc-phone">+750 ECO</span>
                    </li>
                    <li>
                        <div class="tx-info">
                            <span class="tx-time">11:15</span>
                            <div class="tx-details">
                                <strong>Jake Hall</strong> <span class="tx-id">(0.0.481029)</span><br>
                                <span class="tx-meta">8.5kg of Paper</span>
                            </div>
                        </div>
                        <span class="loc-phone">+425 ECO</span>
                    </li>
                    <li>
                        <div class="tx-info">
                            <span class="tx-time">09:45</span>
                            <div class="tx-details">
                                <strong>Ejaz Merchant</strong> <span class="tx-id">(0.0.591823)</span><br>
                                <span class="tx-meta">12.0kg of Glass</span>
                            </div>
                        </div>
                        <span class="loc-phone">+240 ECO</span>
                    </li>
                    <li>
                        <div class="tx-info">
                            <span class="tx-time">08:20</span>
                            <div class="tx-details">
                                <strong>Michiel Mulders</strong> <span class="tx-id">(0.0.339182)</span><br>
                                <span class="tx-meta">5.0kg of Cans</span>
                            </div>
                        </div>
                        <span class="loc-phone">+250 ECO</span>
                    </li>
                </ul>
                
                <div style="text-align: center; margin-top: 0.5rem;">
                    <button class="btn-secondary" style="font-size: 0.9rem; padding: 0.5rem 1rem; border-color: #555; color: #aaa;">
                        Load Previous Activity...
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="success-banner" style="display:none; position:fixed; top:1rem; left:50%; transform:translateX(-50%); background:#0b6623; color:#fff; padding:0.8rem 1.2rem; border-radius:8px; z-index:9999; font-weight: 600;">
        Verification Successful!
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- NEW DYNAMIC DATE ---
    document.getElementById('today-header').textContent = "Today, " + new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    
    const scanBtn = document.getElementById('scan-btn');
    const scanResultsDiv = document.getElementById('scan-results');
    const verifyForm = document.getElementById('verify-form');
    const verifyBtn = document.getElementById('verify-btn');
    const todayList = document.getElementById('today-list');

    // --- NEW: The Calculator Elements ---
    const materialType = document.getElementById('material-type');
    const weightInput = document.getElementById('weight-kg');
    const rewardSummary = document.getElementById('reward-summary');
    const rewardBase = document.getElementById('reward-base');
    const rewardHood = document.getElementById('reward-hood');
    const rewardTier = document.getElementById('reward-tier');
    const rewardTotal = document.getElementById('reward-total');
    let calculatedTotal = 0;

    // Prices for materials
    const prices = {
        'cans': 50,
        'paper': 30,
        'glass': 20
    };

    // --- NEW: FUNCTION TO SHOW THE BANNER ---
    function showBanner(text) {
        const banner = document.getElementById('success-banner');
        banner.textContent = text;
        banner.style.display = 'block';
        setTimeout(() => {
            banner.style.display = 'none';
        }, 2500); // Show for 2.5 seconds
    }

    // --- NEW: The Calculator Function ---
    function calculateReward() {
        const material = materialType.value;
        const weight = parseFloat(weightInput.value);

        if (!material || !weight || weight <= 0) {
            rewardSummary.style.display = 'none';
            verifyBtn.disabled = true;
            verifyBtn.textContent = "Enter Weight & Material";
            return;
        }

        const base = prices[material] * weight;
        const hoodBonus = base * 0.025; // 2.5% Neighborhood Bonus
        const tierBonus = base * 0.01; // 1.0% Bronze Tier Bonus
        calculatedTotal = Math.round(base + hoodBonus + tierBonus);

        // Update the summary box
        rewardBase.textContent = `${base.toFixed(2)} ECO`;
        rewardHood.textContent = `+ ${hoodBonus.toFixed(2)} ECO`;
        rewardTier.textContent = `+ ${tierBonus.toFixed(2)} ECO`;
        rewardTotal.textContent = `${calculatedTotal} ECO`;
        rewardSummary.style.display = 'block';
        
        // Update the button
        verifyBtn.textContent = `Verify & Pay ${calculatedTotal} ECO`;
        verifyBtn.disabled = false;
    }

    // --- NEW: Add event listeners to the form ---
    if (materialType) materialType.addEventListener('change', calculateReward);
    if (weightInput) weightInput.addEventListener('input', calculateReward);


    // 1. When the "Scan" button is clicked
    scanBtn.addEventListener('click', function() {
        scanBtn.style.display = 'none';
        scanResultsDiv.style.display = 'block';
    });

    // 2. When the "Verify & Pay" button is clicked
    verifyForm.addEventListener('submit', function(e) {
        e.preventDefault(); 
        
        verifyBtn.textContent = "Verifying...";
        verifyBtn.disabled = true;

        const formData = new FormData(verifyForm);

        fetch("{{ url_for('confirm_dropoff') }}", {
            method: 'POST',
            credentials: 'same-origin', // <-- send cookies with request
            body: formData
        })
        .then(response => {
            // Try to parse the JSON error message on non-OK
            return response.json().then(data => ({ ok: response.ok, data }));
        })
        .then(({ok, data}) => {
            if (ok && data.success) {
                const now = new Date();
                const timeString = now.toTimeString().substring(0, 5);
                
                const collectorId = "0.0.7267109"; // Demo ID
                const weight = formData.get('weight');
                const material = materialType.options[materialType.selectedIndex].text;
                
                const newItem = document.createElement('li');
                newItem.innerHTML = `
                    <div class="tx-info">
                        <span class="tx-time">${timeString}</span>
                        <div class="tx-details">
                            <strong>Demo User</strong> <span class="tx-id">(${collectorId})</span><br>
                            <span class="tx-meta">${weight}kg of ${material}</span>
                        </div>
                    </div>
                    <span class="loc-phone">+${calculatedTotal} ECO</span>
                `;
                
                todayList.prepend(newItem);
                
                showBanner("Verification Successful!");
                // --- BROADCAST CHANNEL (Real-time signal) ---
                const channel = new BroadcastChannel('vericycle_demo');
                channel.postMessage({
                    type: 'DEPOSIT'
                });
                verifyForm.reset();
                rewardSummary.style.display = 'none';
                scanResultsDiv.style.display = 'none';
                scanBtn.style.display = 'block';     
                
                setTimeout(() => {
                    verifyBtn.disabled = false;
                    calculateReward(); // Resets button text
                }, 2000);

            } else {
                // Show server-provided message when available
                const msg = (data && (data.message || data.error)) ? (data.message || data.error) : 'Error! Try Again.';
                showBanner(msg);
                verifyBtn.textContent = msg;
                verifyBtn.disabled = false;
            }
        })
        .catch(err => {
            console.error('Error:', err);
            showBanner("Error! Try Again.");
            verifyBtn.textContent = "Error! Try Again.";
            verifyBtn.disabled = false;
        });
    });
});
</script>

</body>
</html>