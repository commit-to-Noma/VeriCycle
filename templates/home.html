<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeriCycle - Verified Value</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="dark-theme">
    <header class="navbar">
        <div class="container">
            <h1 class="logo">VeriCycle</h1>
            <nav>
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('collector_dashboard') }}" class="nav-button">Dashboard</a>
                    <a href="{{ url_for('network') }}" class="nav-button">Network</a>
                    <a href="{{ url_for('rewards') }}" class="nav-button">Rewards</a> <a href="{{ url_for('center_dashboard') }}" class="nav-button">Center Dashboard</a>
                    <a href="{{ url_for('logout') }}" class="nav-button">Log Out</a>
                {% else %}
                    <a href="#" class="nav-button js-open-auth" data-form="login">Collector Dashboard</a>
                    <a href="#" class="nav-button js-open-auth" data-form="login">Center Dashboard</a>
                    <a href="#" class="nav-button-primary js-open-auth" data-form="signup">Sign Up</a>
                {% endif %}
            </nav>
        </div>
    </header>

    <main class="hero">
        <div class="container">
            <h2>VeriCycle</h2>
            <h1>Verified Value.</h1>
            <p class="subtitle">Replacing an untrustworthy cash system with a verifiable ledger that protects both the collector and the center.</p>
        </div>
    </main>

    <section class="cta-section">
        <div class="container">
            
            {% if not current_user.is_authenticated %}
                <!-- If they are NOT logged in, show the "Join" section -->
                <h2>Join the VeriCycle Network</h2>
                <p class="cta-subtitle">
                    Become a 'Green Member' today. Turn your recycling efforts into verifiable, secure, and valuable rewards.
                </p>
                
                <div class="advantages">
                    <div class="advantage-card">
                        <h3>‚úÖ Get Paid Safely.</h3>
                        <p>Stop worrying about carrying cash. Your digital EcoCoin wallet is secure.</p>
                    </div>
                    <div class="advantage-card">
                        <h3>ü§ù Get Paid Fairly.</h3>
                        <p>Get a permanent, verifiable receipt for every drop-off. No more disputes.</p>
                    </div>
                    <div class="advantage-card">
                        <h3>üìà Build Your Future.</h3>
                        <p>Build a real, digital income history that can help you get bank loans.</p>
                    </div>
                    <div class="advantage-card">
                        <h3>üí∞ Earn More Than Cash.</h3>
                        <p>Unlock "Bulk Bonuses" and other incentives only available to our 'Green Members'.</p>
                    </div>
                </div>

                <div class="cta-buttons">
                    <a href="#" class="btn-primary-large js-open-auth" data-form="signup">Create Your Account</a>
                    <p>
                        Already have an account? 
                        <a href="#" class="link-secondary js-open-auth" data-form="login">Log In here</a>
                    </p>
                </div>
            
            {% else %}
                <!-- 
                  THIS IS THE FIX FOR BUG 2 (Weird Welcome)
                  It now just says "Welcome Back!"
                -->
                <h2>Welcome Back!</h2>
                <p class="cta-subtitle">
                    You're all set. Head to your dashboard to see your progress.
                </p>
                <div class="cta-buttons">
                    <a href="{{ url_for('collector_dashboard') }}" class="btn-primary-large">Go to My Dashboard</a>
                </div>
            {% endif %}
        </div>
    </section>

    <!-- 
      =====================================================
      THE POP-UP (MODAL)
      =====================================================
    -->
    <div class="modal-overlay" id="auth-modal">
        <div class="card modal-content">
            
            <button class="modal-close js-close-auth">&times;</button>

            <div id="flash-container">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="flash-message {{ category }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>

            <!-- SIGN UP FORM -->
            <div id="signup-form">
                <h2>Create Your Account</h2>
                <form action="{{ url_for('signup') }}" method="POST" class="verify-form">
                    <div class="form-group">
                        <label for="signup-email">Email:</label>
                        <input type="email" id="signup-email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Password:</label>
                        <input type="password" id="signup-password" name="password" required>
                    </div>
                    <button type="submit" class="btn-primary-large btn-form">Create Account</button>
                </form>
                <p>
                    Already have an account? 
                    <a href="#" class="link-secondary js-toggle-auth">Log In</a>
                </p>
            </div>

            <!-- LOG IN FORM -->
            <div id="login-form" style="display: none;">
                <h2>Welcome Back</h2>
                <form action="{{ url_for('login') }}" method="POST" class="verify-form">
                    <div class="form-group">
                        <label for="login-email">Email:</label>
                        <input type="email" id="login-email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password:</label>
                        <input type="password" id="login-password" name="password" required>
                    </div>
                    <button type="submit" class="btn-primary-large btn-form">Log In</button>
                </form>
                <p>
                    Don't have an account? 
                    <a href="#" class="link-secondary js-toggle-auth">Sign Up</a>
                </p>
            </div>
            
        </div>
    </div>
    <!-- End of Modal -->

    <!-- 
      =====================================================
      THE "SMART" JAVASCRIPT
      =====================================================
    -->
    <script>
        const modal = document.getElementById('auth-modal');
        const allOpenButtons = document.querySelectorAll('.js-open-auth');
        const allCloseButtons = document.querySelectorAll('.js-close-auth');
        const allToggleLinks = document.querySelectorAll('.js-toggle-auth');
        
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const flashContainer = document.getElementById('flash-container');

        // Function to open the modal
        const openModal = function(e) {
            e.preventDefault(); 
            const targetForm = this.dataset.form; 
            if (targetForm === 'login') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
            }
            modal.style.display = 'flex'; 
        };

        // Function to close the modal
        const closeModal = function(e) {
            e.preventDefault();
            modal.style.display = 'none'; 
            flashContainer.innerHTML = ''; 
        };

        // Function to toggle between login/signup
        const toggleForms = function(e) {
            e.preventDefault();
            if (loginForm.style.display === 'none') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
            }
        };

        // Attach the functions to the buttons
        allOpenButtons.forEach(btn => btn.addEventListener('click', openModal));
        allCloseButtons.forEach(btn => btn.addEventListener('click', closeModal));
        allToggleLinks.forEach(link => link.addEventListener('click', toggleForms));

        // --- THIS IS THE FIX FOR BUG 1 (THE "UNPROVOKED POP-UP") ---
        // We only want to check for ERROR messages.
        const errorMessages = flashContainer.querySelectorAll('.flash-message.error'); // <--- THIS IS THE FIX
        
        if (errorMessages.length > 0) { // <--- THIS IS THE FIX
            modal.style.display = 'flex'; 
            
            const errorMsg = errorMessages[0].textContent;
            if (errorMsg.includes('Login') || errorMsg.includes('log in') || errorMsg.includes('must be logged in')) {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
            }
        }
        // --- END OF THE FIX ---
    </script>
</body>
</html>